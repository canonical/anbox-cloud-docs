name: Update links to permanent redirects
on:
    workflow_dispatch:
    schedule:
        - cron: "0 1 * * MON"

jobs:
    update-permanent-redirects:
        runs-on: ubuntu-24.04
        steps:
            - name: Check out repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
            - name: Get current date
              id: date
              run: |
                  echo "value=$(date +'%Y-%m-%d')" >> "$GITHUB_OUTPUT"
            - name: Build documentation and check links
              run: |
                  make linkcheck
            - name: Update permanent redirects
              id: update
              run: |
                  python3 scripts/update_redirects.py _build/output.json
                  exit_code=$?
                  if [ $exit_code -eq 2 ]; then
                      echo "no_changes=true" >> "$GITHUB_OUTPUT"
                      echo "No permanent redirects needed updating"
                      exit 0
                  elif [ $exit_code -ne 0 ]; then
                      echo "Script failed with exit code $exit_code"
                      exit $exit_code
                  fi
                  echo "no_changes=false" >> "$GITHUB_OUTPUT"
            - name: Verify updated links
              if: steps.update.outputs.no_changes != 'true'
              run: |
                  make linkcheck
            - name: Create pull request
              if: steps.update.outputs.no_changes != 'true'
              uses: canonical/create-pull-request@fdc6a8d4844a2c56566be64e90c536f1ae1bd6c3
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: "feat: update links to permanent redirects"
                  branch-name: update-permanent-redirects-${{ steps.date.outputs.value }}
                  title: Update links to permanent redirects (${{ steps.date.outputs.value }})
                  body: |
                      This updates documentation links that have permanent redirects (HTTP 301/308) to point
                      directly to their new locations as of ${{ steps.date.outputs.value }}.

                      You have to close and reopen the PR to trigger checks.
                  repository: canonical/anbox-cloud-docs
                  upsert: true
                  ignore-no-changes: true
